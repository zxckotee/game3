# План по редизайну системы квестов

**Цель:** Переработать систему квестов, чтобы они были логично вплетены в существующие механики игры, и автоматизировать отслеживание прогресса на основе действий игрока.

---

### **Этап 1: Обновление Базы Данных и Контента Квестов**

**Цель:** Привести структуру и содержание квестов в соответствие с игровыми реалиями.

1.  **Изменить структуру таблицы `quest_objectives`:**
    *   **Действие:** Добавить поля `type` (тип цели) и `target` (ID цели) в таблицу `quest_objectives`.
    *   **Файл:** `sql/01_quests.sql`
    *   **Типы целей:** `GATHER_ITEM`, `DEFEAT_ENEMY`, `CRAFT_ITEM`, `REACH_LEVEL`.

2.  **Переработать квесты:**
    *   **Действие:** Удалить невыполнимые квесты (`q4`, `q5`) и заменить их новыми, основанными на алхимии и культивации. Обновить все цели, заполнив поля `type` и `target`.
    *   **Файл:** `sql/01_quests.sql`

    **Пример новых квестов:**
    *   **"Путь Алхимика" (Побочный):** Создать 3 пилюли очищения.
    *   **"Закалка в бою" (Ежедневный):** Победить 5 любых духовных зверей.
    *   **"Прорыв в познании" (Основной):** Достигнуть 3-го уровня культивации.

---

### **Этап 2: Обновление Моделей**

**Цель:** Синхронизировать модели данных с новой структурой БД.

1.  **Обновить модель `QuestObjective`:**
    *   **Действие:** Добавить поля `type` и `target` в модель.
    *   **Файл:** `src/models/quest-objective.js`

---

### **Этап 3: Реализация "Умного" Сервиса Квестов**

**Цель:** Создать централизованный обработчик игровых событий для автоматического обновления прогресса квестов.

1.  **Создать `QuestService.checkQuestEvent`:**
    *   **Действие:** Реализовать метод `checkQuestEvent(userId, eventType, payload)`, который будет:
        1.  Находить активные квесты пользователя.
        2.  Искать в них цели, соответствующие `eventType`.
        3.  Сравнивать `payload` (например, `itemId` или `enemyId`) с полем `target` у цели.
        4.  При совпадении вызывать `addObjectiveProgress`.
    *   **Файл:** `src/services/quest-service.js`

2.  **Интегрировать `checkQuestEvent` в другие сервисы:**
    *   **Действие:** Внедрить вызовы `checkQuestEvent` в ключевые методы других сервисов:
        *   `inventory-service.js` -> `addInventoryItem`
        *   `combat-service.js` -> `_processRewards`
        *   `alchemy-service.js` -> `craftItem`
        *   `cultivation-service.js` -> `updateCultivationProgress`