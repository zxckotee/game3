import React, { useState, useEffect } from 'react';
import styled from 'styled-components';
import { useGame } from '../../context/GameContext';
import { debugEquipment } from '../../utils/equipmentDebug';
import { ensureItemHasCalculatedBonuses } from '../../utils/equipmentBonusHelper';
import { calculateEquipmentBonusesFromInventory } from '../../utils/equipmentBonusCalculator';
import { 
  updatePlayerEquipmentBonuses,
  handleEquipItem,
  handleUnequipItem,
  initializeEquipmentBonuses
} from '../../utils/equipmentStateUpdater';

const Container = styled.div`
  display: grid;
  grid-template-columns: 400px 1fr;
  gap: 20px;
`;

const EquipmentDisplay = styled.div`
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #d4af37;
  border-radius: 8px;
  padding: 20px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-auto-rows: minmax(100px, auto);
  grid-gap: 20px;
  max-width: 100%;
`;

const EquipmentSlot = styled.div`
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #666;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  padding: 10px;
  cursor: pointer;
  height: 100px;
  
  &.head {
    grid-column: 1 / span 3;
    height: 80px;
  }
  
  &.body {
    grid-column: 2;
    grid-row: 2;
  }
  
  &.left {
    grid-column: 1;
    grid-row: 2;
  }
  
  &.right {
    grid-column: 3;
    grid-row: 2;
  }
  
  &.hands {
    grid-column: 1 / span 3;
    grid-row: 3;
    height: 80px;
  }
  
  &.legs {
    grid-column: 1 / span 3;
    grid-row: 4;
    height: 80px;
  }
  
  &.acc1 {
    grid-column: 1;
    grid-row: 5;
  }
  
  &.acc2 {
    grid-column: 3;
    grid-row: 5;
  }
  
  &.art1 {
    grid-column: 1;
    grid-row: 6;
  }
  
  &.art2 {
    grid-column: 3;
    grid-row: 6;
  }
  
  &.equipped {
    border-color: ${props => props.rarity === 'common' ? '#666' :
      props.rarity === 'uncommon' ? '#2196f3' :
      props.rarity === 'rare' ? '#9c27b0' :
      props.rarity === 'epic' ? '#ff9800' : '#d4af37'};
    box-shadow: 0 0 5px ${props => props.rarity === 'common' ? '#666' :
      props.rarity === 'uncommon' ? '#2196f3' :
      props.rarity === 'rare' ? '#9c27b0' :
      props.rarity === 'epic' ? '#ff9800' : '#d4af37'};
  }
`;

const SlotName = styled.div`
  color: #aaa;
  font-size: 0.8rem;
  margin-bottom: 5px;
`;

const ItemIcon = styled.div`
  width: 40px;
  height: 40px;
  background: ${props => props.type === 'weapon' ? '#f44336' :
    props.type === 'armor' ? '#2196f3' :
    props.type === 'accessory' ? '#9c27b0' :
    props.type === 'artifact' ? '#ff9800' :
    props.type === 'material' ? '#4caf50' :
    props.type === 'book' ? '#795548' : '#666'};
  border-radius: 4px;
`;

const ItemName = styled.div`
  color: ${props => props.rarity === 'common' ? '#fff' :
    props.rarity === 'uncommon' ? '#2196f3' :
    props.rarity === 'rare' ? '#9c27b0' :
    props.rarity === 'epic' ? '#ff9800' : '#d4af37'};
  font-size: 0.9rem;
  margin-top: 5px;
  text-align: center;
`;

const StatsPanel = styled.div`
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #d4af37;
  border-radius: 8px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
`;

const UnequipButton = styled.button`
  padding: 10px 15px;
  background: rgba(180, 30, 30, 0.3);
  border: 1px solid #d4af37;
  border-radius: 4px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  transition: all 0.2s ease;
  
  &:hover:not(:disabled) {
    background: rgba(180, 30, 30, 0.5);
  }
  
  &:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
`;

const DropButton = styled.button`
  padding: 10px 15px;
  background: rgba(180, 30, 30, 0.3);
  border: 1px solid #d4af37;
  border-radius: 4px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  width: 100%;
  transition: all 0.2s ease;
  
  &:hover:not(:disabled) {
    background: rgba(180, 30, 30, 0.5);
  }
  
  &:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
`;

const SectionTitle = styled.h3`
  color: #d4af37;
  font-size: 1.2rem;
  margin-bottom: 10px;
  border-bottom: 1px solid rgba(212, 175, 55, 0.3);
  padding-bottom: 5px;
`;

const StatGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
`;

const StatItem = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  
  span:first-child {
    color: #aaa;
  }
  
  span:last-child {
    color: ${props => props.value > 0 ? '#4caf50' : props.value < 0 ? '#f44336' : '#aaa'};
  }
`;

const FilterButtons = styled.div`
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
`;

const FilterButton = styled.button`
  padding: 8px 15px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #666;
  border-radius: 4px;
  color: #aaa;
  cursor: pointer;
  transition: all 0.2s ease;
  
  &:hover {
    background: rgba(0, 0, 0, 0.5);
  }
  
  &.active {
    background: rgba(212, 175, 55, 0.2);
    border-color: #d4af37;
    color: #d4af37;
  }
`;

const InventoryGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 10px;
  padding: 15px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #666;
  border-radius: 8px;
`;

const ItemSlot = styled.div`
  width: 100%;
  aspect-ratio: 1;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid ${props => props.rarity === 'common' ? '#666' :
    props.rarity === 'uncommon' ? '#2196f3' :
    props.rarity === 'rare' ? '#9c27b0' :
    props.rarity === 'epic' ? '#ff9800' : '#d4af37'};
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  position: relative;
  cursor: pointer;
  transition: all 0.2s ease;
  
  &:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px ${props => props.rarity === 'common' ? '#666' :
      props.rarity === 'uncommon' ? '#2196f3' :
      props.rarity === 'rare' ? '#9c27b0' :
      props.rarity === 'epic' ? '#ff9800' : '#d4af37'};
  }
  
  &.equipped {
    border-width: 2px;
    box-shadow: 0 0 5px ${props => props.rarity === 'common' ? '#666' :
      props.rarity === 'uncommon' ? '#2196f3' :
      props.rarity === 'rare' ? '#9c27b0' :
      props.rarity === 'epic' ? '#ff9800' : '#d4af37'};
  }
`;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –±—Ä–æ–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ armorType –∏ –Ω–∞–∑–≤–∞–Ω–∏—è
const determineArmorType = (item) => {
  if (!item) return null;
  
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–ø
  const armorType = item.properties?.armorType || item.armorType;
  if (armorType) return armorType;
  
  // –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ —É–∫–∞–∑–∞–Ω, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
  const itemName = item.name.toLowerCase();
  
  if (itemName.includes('—à–ª–µ–º') || itemName.includes('—à–∞–ø–∫–∞') || itemName.includes('–∫–∞–ø—é—à–æ–Ω')) {
    return 'head';
  }
  
  if (itemName.includes('—Å–∞–ø–æ–≥') || itemName.includes('–±–æ—Ç–∏–Ω') || itemName.includes('–æ–±—É–≤—å')) {
    return 'legs';
  }
  
  if (itemName.includes('–ø–µ—Ä—á–∞—Ç') || itemName.includes('—Ä—É–∫–∞–≤')) {
    return 'hands';
  }
  
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –±—Ä–æ–Ω–µ–π –¥–ª—è —Ç–µ–ª–∞
  return 'body';
};

function EquipmentTab() {
  const { state, actions } = useGame();
  const [equipped, setEquipped] = useState({
    weapon: null,
    headArmor: null,
    bodyArmor: null,
    legArmor: null,
    handArmor: null,
    accessory1: null,
    accessory2: null,
    artifact1: null,
    artifact2: null
  });
  const [filter, setFilter] = useState('all');
  const [selectedSlot, setSelectedSlot] = useState(null);
  const [selectedEquippedItem, setSelectedEquippedItem] = useState(null);
  const [selectedInventoryItem, setSelectedInventoryItem] = useState(null);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  const isMounted = React.useRef(false);
  
  useEffect(() => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–∫–∏–ø–∏—Ä–æ–≤–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    if (isMounted.current) {
      return;
    }
    
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏');
    isMounted.current = true;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    updateEquippedItems();
    
    // –ù–û–í–û–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ–Ω—É—Å—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
    initializeEquipmentBonuses(state, actions.dispatch);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É –æ—Ç–ª–∞–¥–æ—á–Ω—É—é —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    setTimeout(() => {
      debugEquipment(state);
    }, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –±–æ–Ω—É—Å—ã —É—Å–ø–µ–ª–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è
  }, []); // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
  useEffect(() => {
    if (!isMounted.current) {
      return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É, –æ–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—ã—à–µ
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateEquippedItems();
    
    // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    updatePlayerEquipmentBonuses(state, actions.dispatch);
  }, [state.player.inventory?.items]);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
  const updateEquippedItems = () => {
    if (!state.player?.inventory?.items) {
      console.warn('–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return {};
    }
    
    const equippedItems = {
      weapon: null,
      headArmor: null,
      bodyArmor: null,
      legArmor: null,
      handArmor: null,
      accessory1: null,
      accessory2: null,
      artifact1: null,
      artifact2: null
    };
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    const equippedItemsList = state.player.inventory.items.filter(item => item.equipped);
    
    console.log('==== –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–ö–ò–ü–ò–†–û–í–ê–ù–ù–´–• –ü–†–ï–î–ú–ï–¢–û–í ====');
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${equippedItemsList.length} —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤`);
    
    // –ù–∞—Ö–æ–¥–∏–º —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    state.player.inventory.items.forEach(item => {
      if (item.equipped) {
        switch(item.type) {
          case 'weapon':
            equippedItems.weapon = item;
            console.log(`‚öîÔ∏è –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ –æ—Ä—É–∂–∏–µ: ${item.name}`);
            break;
          case 'armor':
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –±—Ä–æ–Ω–∏
            const armorType = determineArmorType(item);
            
            if (armorType === 'head') {
              equippedItems.headArmor = item;
              console.log(`üß¢ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–æ–Ω—è –¥–ª—è –≥–æ–ª–æ–≤—ã: ${item.name}`);
            }
            else if (armorType === 'legs') {
              equippedItems.legArmor = item;
              console.log(`üë¢ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–æ–Ω—è –¥–ª—è –Ω–æ–≥: ${item.name}`);
            }
            else if (armorType === 'hands') {
              equippedItems.handArmor = item;
              console.log(`üß§ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–æ–Ω—è –¥–ª—è —Ä—É–∫: ${item.name}`);
            }
            else {
              equippedItems.bodyArmor = item;
              console.log(`üëï –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–æ–Ω—è –¥–ª—è —Ç–µ–ª–∞: ${item.name}`);
            }
            break;
          case 'accessory':
            if (!equippedItems.accessory1) {
              equippedItems.accessory1 = item;
              console.log(`üíç –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω –∞–∫—Å–µ—Å—Å—É–∞—Ä 1: ${item.name}`);
            } else if (!equippedItems.accessory2) {
              equippedItems.accessory2 = item;
              console.log(`üíç –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω –∞–∫—Å–µ—Å—Å—É–∞—Ä 2: ${item.name}`);
            }
            break;
          case 'artifact':
            if (!equippedItems.artifact1) {
              equippedItems.artifact1 = item;
              console.log(`üè∫ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç 1: ${item.name}`);
            } else if (!equippedItems.artifact2) {
              equippedItems.artifact2 = item;
              console.log(`üè∫ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç 2: ${item.name}`);
            }
            break;
        }
      }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    setEquipped(equippedItems);
    
    return equippedItems;
  };
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
  const handleSlotClick = (slotType) => {
    setSelectedSlot(slotType);
    setSelectedEquippedItem(null);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
    switch(slotType) {
      case 'weapon':
        setFilter('weapon');
        break;
      case 'headArmor':
      case 'bodyArmor':
      case 'legArmor':
      case 'handArmor':
        setFilter('armor');
        break;
      case 'accessory1':
      case 'accessory2':
        setFilter('accessory');
        break;
      case 'artifact1':
      case 'artifact2':
        setFilter('artifact');
        break;
    }
  };
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
  const handleEquippedItemClick = (item, slot) => {
    setSelectedSlot(slot);
    setSelectedEquippedItem(item);
    setSelectedInventoryItem(null);
  };
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
  const handleInventoryItemClick = (item) => {
    setSelectedInventoryItem(item);
    setSelectedEquippedItem(null);
  };
  
  // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–∞
  const handleEquipItemClick = (itemId) => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–∞
    handleEquipItem(state, actions.dispatch, itemId);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
    setSelectedInventoryItem(null);
    setSelectedSlot(null);
    
    // –î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
    setTimeout(() => {
      updateEquippedItems();
    }, 100);
  };
  
  // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–Ω—è—Ç–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
  const handleUnequipItemClick = (itemId) => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–Ω—è—Ç–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
    handleUnequipItem(state, actions.dispatch, itemId);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
    setSelectedEquippedItem(null);
    
    // –î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
    setTimeout(() => {
      updateEquippedItems();
    }, 100);
  };
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ª–æ—Ç–∞ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
  const renderEquipmentSlot = (slotType, name, className) => {
    const item = equipped[slotType];
    
    return (
      <EquipmentSlot 
        className={`${className} ${selectedSlot === slotType ? 'selected' : ''} ${item ? 'equipped' : ''}`}
        onClick={() => item ? handleEquippedItemClick(item, slotType) : handleSlotClick(slotType)}
        rarity={item?.rarity}
      >
        <SlotName>{name}</SlotName>
        {item ? (
          <>
            <ItemIcon type={item.type} />
            <ItemName rarity={item.rarity}>{item.name}</ItemName>
          </>
        ) : (
          <div>–ù–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</div>
        )}
      </EquipmentSlot>
    );
  };
  
  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
  const filteredItems = React.useMemo(() => {
    if (!state.player?.inventory?.items) return [];
    
    let filteredList = state.player.inventory.items;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä
    if (filter !== 'all') {
      filteredList = filteredList.filter(item => item.type === filter);
    }
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–ª–æ—Ç, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–¥—Ç–∏–ø—É –¥–ª—è –±—Ä–æ–Ω–∏
    if (selectedSlot) {
      if (selectedSlot === 'headArmor') {
        filteredList = filteredList.filter(item => 
          item.type === 'armor' && (
            (item.properties?.armorType === 'head') || 
            (!item.properties?.armorType && determineArmorType(item) === 'head')
          )
        );
      } else if (selectedSlot === 'bodyArmor') {
        filteredList = filteredList.filter(item => 
          item.type === 'armor' && (
            (item.properties?.armorType === 'body') || 
            (!item.properties?.armorType && determineArmorType(item) === 'body')
          )
        );
      } else if (selectedSlot === 'legArmor') {
        filteredList = filteredList.filter(item => 
          item.type === 'armor' && (
            (item.properties?.armorType === 'legs') || 
            (!item.properties?.armorType && determineArmorType(item) === 'legs')
          )
        );
      } else if (selectedSlot === 'handArmor') {
        filteredList = filteredList.filter(item => 
          item.type === 'armor' && (
            (item.properties?.armorType === 'hands') || 
            (!item.properties?.armorType && determineArmorType(item) === 'hands')
          )
        );
      }
    }
    
    return filteredList;
  }, [state.player?.inventory?.items, filter, selectedSlot]);
  
  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–µ–¥–º–µ—Ç–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
  const renderEquippedItemDetails = () => {
    if (!selectedEquippedItem) return null;
    
    // –ù–û–í–û–ï: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    const itemBonuses = calculateEquipmentBonusesFromInventory([selectedEquippedItem]);
    
    return (
      <StatsPanel>
        <SectionTitle>–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç: {selectedEquippedItem.name}</SectionTitle>
        
        {/* –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <SectionTitle>–ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</SectionTitle>
        <StatGrid>
          {Object.entries(itemBonuses.stats).map(([stat, value]) => {
            if (value === 0) return null;
            
            const statNames = {
              'strength': '–°–∏–ª–∞',
              'dexterity': '–õ–æ–≤–∫–æ—Å—Ç—å',
              'vitality': '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å',
              'intelligence': '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',
              'perception': '–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ',
              'luck': '–£–¥–∞—á–∞'
            };
            
            return (
              <StatItem key={stat} value={value}>
                <span>{statNames[stat] || stat}</span>
                <span>{value > 0 ? `+${value}` : value}</span>
              </StatItem>
            );
          })}
        </StatGrid>
        
        {/* –ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <SectionTitle>–ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</SectionTitle>
        <StatGrid>
          {Object.entries(itemBonuses.combat).map(([stat, value]) => {
            if (value === 0) return null;
            
            const statNames = {
              'physicalDamage': '–§–∏–∑–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω',
              'magicDamage': '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω',
              'physicalDefense': '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞',
              'magicDefense': '–ú–∞–≥–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞',
              'critChance': '–®–∞–Ω—Å –∫—Ä–∏—Ç. —É–¥–∞—Ä–∞',
              'critDamage': '–£—Ä–æ–Ω –æ—Ç –∫—Ä–∏—Ç. —É–¥–∞—Ä–∞',
              'dodgeChance': '–®–∞–Ω—Å —É–∫–ª–æ–Ω–µ–Ω–∏—è'
            };
            
            const suffix = ['critChance', 'critDamage', 'dodgeChance'].includes(stat) ? '%' : '';
            
            return (
              <StatItem key={stat} value={value}>
                <span>{statNames[stat] || stat}</span>
                <span>{value > 0 ? `+${value}${suffix}` : `${value}${suffix}`}</span>
              </StatItem>
            );
          })}
        </StatGrid>
        
        {/* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫—É–ª—å—Ç–∏–≤–∞—Ü–∏–∏ */}
        {Object.values(itemBonuses.cultivation).some(v => v !== 0) && (
          <>
            <SectionTitle>–ö—É–ª—å—Ç–∏–≤–∞—Ü–∏—è</SectionTitle>
            <StatGrid>
              {Object.entries(itemBonuses.cultivation).map(([stat, value]) => {
                if (value === 0) return null;
                
                const statNames = {
                  'energyMax': '–ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è',
                  'energyRegen': '–í–æ—Å—Å—Ç. —ç–Ω–µ—Ä–≥–∏–∏',
                  'comprehensionRate': '–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏—è',
                  'breakthroughChance': '–®–∞–Ω—Å –ø—Ä–æ—Ä—ã–≤–∞'
                };
                
                const suffix = stat === 'energyRegen' ? '/—á–∞—Å' : 
                  ['comprehensionRate', 'breakthroughChance'].includes(stat) ? '%' : '';
                
                return (
                  <StatItem key={stat} value={value}>
                    <span>{statNames[stat] || stat}</span>
                    <span>{value > 0 ? `+${value}${suffix}` : `${value}${suffix}`}</span>
                  </StatItem>
                );
              })}
            </StatGrid>
          </>
        )}
        
        {/* –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–æ–Ω—É—Å—ã */}
        {Object.values(itemBonuses.elemental).some(v => v !== 0) && (
          <>
            <SectionTitle>–°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–æ–Ω—É—Å—ã</SectionTitle>
            <StatGrid>
              {Object.entries(itemBonuses.elemental).map(([element, value]) => {
                if (value === 0) return null;
                
                const elementNames = {
                  'fire': '–û–≥–æ–Ω—å',
                  'water': '–í–æ–¥–∞',
                  'earth': '–ó–µ–º–ª—è',
                  'air': '–í–æ–∑–¥—É—Ö',
                  'light': '–°–≤–µ—Ç',
                  'dark': '–¢—å–º–∞'
                };
                
                return (
                  <StatItem key={element} value={value}>
                    <span>{elementNames[element] || element}</span>
                    <span>{value > 0 ? `+${value}` : value}</span>
                  </StatItem>
                );
              })}
            </StatGrid>
          </>
        )}
        
        {/* –û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */}
        {itemBonuses.special.length > 0 && (
          <>
            <SectionTitle>–û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</SectionTitle>
            {itemBonuses.special.map((effect, index) => (
              <div key={effect.id || index} style={{ marginBottom: '10px' }}>
                <div style={{ color: '#d4af37', fontWeight: 'bold' }}>{effect.name}</div>
                <div>{effect.description}</div>
              </div>
            ))}
          </>
        )}
        
        {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–Ω—è—Ç–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ */}
        <UnequipButton onClick={() => handleUnequipItemClick(selectedEquippedItem.id)}>
          –°–Ω—è—Ç—å
        </UnequipButton>
      </StatsPanel>
    );
  };
  
  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–µ–¥–º–µ—Ç–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
  const renderInventoryItemDetails = () => {
    if (!selectedInventoryItem) return null;
    
    // –ù–û–í–û–ï: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    const itemBonuses = calculateEquipmentBonusesFromInventory([selectedInventoryItem]);
    
    return (
      <StatsPanel>
        <SectionTitle>–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç: {selectedInventoryItem.name}</SectionTitle>
        
        {/* –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <SectionTitle>–ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</SectionTitle>
        <StatGrid>
          {Object.entries(itemBonuses.stats).map(([stat, value]) => {
            if (value === 0) return null;
            
            const statNames = {
              'strength': '–°–∏–ª–∞',
              'dexterity': '–õ–æ–≤–∫–æ—Å—Ç—å',
              'vitality': '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å',
              'intelligence': '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',
              'perception': '–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ',
              'luck': '–£–¥–∞—á–∞'
            };
            
            return (
              <StatItem key={stat} value={value}>
                <span>{statNames[stat] || stat}</span>
                <span>{value > 0 ? `+${value}` : value}</span>
              </StatItem>
            );
          })}
        </StatGrid>
        
        {/* –ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <SectionTitle>–ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</SectionTitle>
        <StatGrid>
          {Object.entries(itemBonuses.combat).map(([stat, value]) => {
            if (value === 0) return null;
            
            const statNames = {
              'physicalDamage': '–§–∏–∑–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω',
              'magicDamage': '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω',
              'physicalDefense': '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞',
              'magicDefense': '–ú–∞–≥–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞',
              'critChance': '–®–∞–Ω—Å –∫—Ä–∏—Ç. —É–¥–∞—Ä–∞',
              'critDamage': '–£—Ä–æ–Ω –æ—Ç –∫—Ä–∏—Ç. —É–¥–∞—Ä–∞',
              'dodgeChance': '–®–∞–Ω—Å —É–∫–ª–æ–Ω–µ–Ω–∏—è'
            };
            
            const suffix = ['critChance', 'critDamage', 'dodgeChance'].includes(stat) ? '%' : '';
            
            return (
              <StatItem key={stat} value={value}>
                <span>{statNames[stat] || stat}</span>
                <span>{value > 0 ? `+${value}${suffix}` : `${value}${suffix}`}</span>
              </StatItem>
            );
          })}
        </StatGrid>
        
        {/* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫—É–ª—å—Ç–∏–≤–∞—Ü–∏–∏ */}
        {Object.values(itemBonuses.cultivation).some(v => v !== 0) && (
          <>
            <SectionTitle>–ö—É–ª—å—Ç–∏–≤–∞—Ü–∏—è</SectionTitle>
            <StatGrid>
              {Object.entries(itemBonuses.cultivation).map(([stat, value]) => {
                if (value === 0) return null;
                
                const statNames = {
                  'energyMax': '–ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è',
                  'energyRegen': '–í–æ—Å—Å—Ç. —ç–Ω–µ—Ä–≥–∏–∏',
                  'comprehensionRate': '–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏—è',
                  'breakthroughChance': '–®–∞–Ω—Å –ø—Ä–æ—Ä—ã–≤–∞'
                };
                
                const suffix = stat === 'energyRegen' ? '/—á–∞—Å' : 
                  ['comprehensionRate', 'breakthroughChance'].includes(stat) ? '%' : '';
                
                return (
                  <StatItem key={stat} value={value}>
                    <span>{statNames[stat] || stat}</span>
                    <span>{value > 0 ? `+${value}${suffix}` : `${value}${suffix}`}</span>
                  </StatItem>
                );
              })}
            </StatGrid>
          </>
        )}
        
        {/* –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–æ–Ω—É—Å—ã */}
        {Object.values(itemBonuses.elemental).some(v => v !== 0) && (
          <>
            <SectionTitle>–°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–æ–Ω—É—Å—ã</SectionTitle>
            <StatGrid>
              {Object.entries(itemBonuses.elemental).map(([element, value]) => {
                if (value === 0) return null;
                
                const elementNames = {
                  'fire': '–û–≥–æ–Ω—å',
                  'water': '–í–æ–¥–∞',
                  'earth': '–ó–µ–º–ª—è',
                  'air': '–í–æ–∑–¥—É—Ö',
                  'light': '–°–≤–µ—Ç',
                  'dark': '–¢—å–º–∞'
                };
                
                return (
                  <StatItem key={element} value={value}>
                    <span>{elementNames[element] || element}</span>
                    <span>{value > 0 ? `+${value}` : value}</span>
                  </StatItem>
                );
              })}
            </StatGrid>
          </>
        )}
        
        {/* –û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */}
        {itemBonuses.special.length > 0 && (
          <>
            <SectionTitle>–û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</SectionTitle>
            {itemBonuses.special.map((effect, index) => (
              <div key={effect.id || index} style={{ marginBottom: '10px' }}>
                <div style={{ color: '#d4af37', fontWeight: 'bold' }}>{effect.name}</div>
                <div>{effect.description}</div>
              </div>
            ))}
          </>
        )}
        
        {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ */}
        <UnequipButton 
          onClick={() => handleEquipItemClick(selectedInventoryItem.id)}
          disabled={selectedInventoryItem.equipped}
        >
          {selectedInventoryItem.equipped ? '–£–∂–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å'}
        </UnequipButton>
      </StatsPanel>
    );
  };
  
  // –ù–û–í–û–ï: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –±–æ–Ω—É—Å–æ–≤ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
  const renderEquipmentBonuses = () => {
    const { equipmentBonuses } = state.player || {};
    
    if (!equipmentBonuses) {
      return (
        <StatsPanel>
          <SectionTitle>–ë–æ–Ω—É—Å—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏</SectionTitle>
          <div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏</div>
        </StatsPanel>
      );
    }
    
    return (
      <StatsPanel>
        <SectionTitle>–ë–æ–Ω—É—Å—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏</SectionTitle>
        
        {/* –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <SectionTitle>–ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</SectionTitle>
        <StatGrid>
          {Object.entries(equipmentBonuses.stats).map(([stat, value]) => {
            const statNames = {
              'strength': '–°–∏–ª–∞',
              'dexterity': '–õ–æ–≤–∫–æ—Å—Ç—å',
              'vitality': '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å',
              'intelligence': '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',
              'perception': '–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ',
              'luck': '–£–¥–∞—á–∞'
            };
            
            return (
              <StatItem key={stat} value={value}>
                <span>{statNames[stat] || stat}</span>
                <span>{value > 0 ? `+${value}` : value}</span>
              </StatItem>
            );
          })}
        </StatGrid>
        
        {/* –ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
        <SectionTitle>–ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</SectionTitle>
        <StatGrid>
          {Object.entries(equipmentBonuses.combat).map(([stat, value]) => {
            const statNames = {
              'physicalDamage': '–§–∏–∑–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω',
              'magicDamage': '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω',
              'physicalDefense': '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞',
              'magicDefense': '–ú–∞–≥–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞',
              'critChance': '–®–∞–Ω—Å –∫—Ä–∏—Ç. —É–¥–∞—Ä–∞',
              'critDamage': '–£—Ä–æ–Ω –æ—Ç –∫—Ä–∏—Ç. —É–¥–∞—Ä–∞',
              'dodgeChance': '–®–∞–Ω—Å —É–∫–ª–æ–Ω–µ–Ω–∏—è'
            };
            
            const suffix = ['critChance', 'critDamage', 'dodgeChance'].includes(stat) ? '%' : '';
            
            return (
              <StatItem key={stat} value={value}>
                <span>{statNames[stat] || stat}</span>
                <span>{value > 0 ? `+${value}${suffix}` : `${value}${suffix}`}</span>
              </StatItem>
            );
          })}
        </StatGrid>
        
        {/* –ö—É–ª—å—Ç–∏–≤–∞—Ü–∏—è */}
        {Object.values(equipmentBonuses.cultivation).some(v => v !== 0) && (
          <>
            <SectionTitle>–ö—É–ª—å—Ç–∏–≤–∞—Ü–∏—è</SectionTitle>
            <StatGrid>
              {Object.entries(equipmentBonuses.cultivation).map(([stat, value]) => {
                if (value === 0) return null;
                
                const statNames = {
                  'energyMax': '–ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è',
                  'energyRegen': '–í–æ—Å—Å—Ç. —ç–Ω–µ—Ä–≥–∏–∏',
                  'comprehensionRate': '–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏—è',
                  'breakthroughChance': '–®–∞–Ω—Å –ø—Ä–æ—Ä—ã–≤–∞'
                };
                
                const suffix = stat === 'energyRegen' ? '/—á–∞—Å' : 
                  ['comprehensionRate', 'breakthroughChance'].includes(stat) ? '%' : '';
                
                return (
                  <StatItem key={stat} value={value}>
                    <span>{statNames[stat] || stat}</span>
                    <span>{value > 0 ? `+${value}${suffix}` : `${value}${suffix}`}</span>
                  </StatItem>
                );
              })}
            </StatGrid>
          </>
        )}
        
        {/* –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–æ–Ω—É—Å—ã */}
        {Object.values(equipmentBonuses.elemental).some(v => v !== 0) && (
          <>
            <SectionTitle>–°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–æ–Ω—É—Å—ã</SectionTitle>
            <StatGrid>
              {Object.entries(equipmentBonuses.elemental).map(([element, value]) => {
                if (value === 0) return null;
                
                const elementNames = {
                  'fire': '–û–≥–æ–Ω—å',
                  'water': '–í–æ–¥–∞',
                  'earth': '–ó–µ–º–ª—è',
                  'air': '–í–æ–∑–¥—É—Ö',
                  'light': '–°–≤–µ—Ç',
                  'dark': '–¢—å–º–∞'
                };
                
                return (
                  <StatItem key={element} value={value}>
                    <span>{elementNames[element] || element}</span>
                    <span>{value > 0 ? `+${value}` : value}</span>
                  </StatItem>
                );
              })}
            </StatGrid>
          </>
        )}
        
        {/* –û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */}
        {equipmentBonuses.special.length > 0 && (
          <>
            <SectionTitle>–û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</SectionTitle>
            {equipmentBonuses.special.map((effect, index) => (
              <div key={effect.id || index} style={{ marginBottom: '10px' }}>
                <div style={{ color: '#d4af37', fontWeight: 'bold' }}>{effect.name}</div>
                <div>{effect.description}</div>
              </div>
            ))}
          </>
        )}
        
        {/* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) */}
        <UnequipButton 
          onClick={() => updatePlayerEquipmentBonuses(state, actions.dispatch)}
          style={{ background: 'rgba(0, 100, 0, 0.3)' }}
        >
          –û–±–Ω–æ–≤–∏—Ç—å –±–æ–Ω—É—Å—ã
        </UnequipButton>
      </StatsPanel>
    );
  };
  
  return (
    <Container>
      <div>
        <SectionTitle>–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</SectionTitle>
        <EquipmentDisplay>
          {renderEquipmentSlot('headArmor', '–ì–æ–ª–æ–≤–∞', 'head')}
          {renderEquipmentSlot('weapon', '–û—Ä—É–∂–∏–µ', 'left')}
          {renderEquipmentSlot('bodyArmor', '–¢–µ–ª–æ', 'body')}
          {renderEquipmentSlot('accessory1', '–ê–∫—Å–µ—Å—Å—É–∞—Ä 1', 'right')}
          {renderEquipmentSlot('handArmor', '–†—É–∫–∏', 'hands')}
          {renderEquipmentSlot('legArmor', '–ù–æ–≥–∏', 'legs')}
          {renderEquipmentSlot('artifact1', '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç 1', 'art1')}
          {renderEquipmentSlot('accessory2', '–ê–∫—Å–µ—Å—Å—É–∞—Ä 2', 'acc1')}
          {renderEquipmentSlot('artifact2', '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç 2', 'art2')}
        </EquipmentDisplay>
        
        {(selectedSlot || selectedInventoryItem) && (
          <>
            <SectionTitle style={{ marginTop: '20px' }}>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</SectionTitle>
            <FilterButtons>
              <FilterButton 
                className={filter === 'all' ? 'active' : ''}
                onClick={() => setFilter('all')}
              >
                –í—Å–µ
              </FilterButton>
              <FilterButton 
                className={filter === 'weapon' ? 'active' : ''}
                onClick={() => setFilter('weapon')}
              >
                –û—Ä—É–∂–∏–µ
              </FilterButton>
              <FilterButton 
                className={filter === 'armor' ? 'active' : ''}
                onClick={() => setFilter('armor')}
              >
                –ë—Ä–æ–Ω—è
              </FilterButton>
              <FilterButton 
                className={filter === 'accessory' ? 'active' : ''}
                onClick={() => setFilter('accessory')}
              >
                –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã
              </FilterButton>
              <FilterButton 
                className={filter === 'artifact' ? 'active' : ''}
                onClick={() => setFilter('artifact')}
              >
                –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
              </FilterButton>
            </FilterButtons>
            
            <InventoryGrid>
              {filteredItems.map(item => (
                <ItemSlot 
                  key={item.id} 
                  rarity={item.rarity}
                  onClick={() => handleInventoryItemClick(item)}
                  className={`${item.equipped ? 'equipped' : ''} ${selectedInventoryItem?.id === item.id ? 'selected' : ''}`}
                >
                  <ItemIcon type={item.type} />
                  <ItemName rarity={item.rarity}>{item.name}</ItemName>
                </ItemSlot>
              ))}
            </InventoryGrid>
          </>
        )}
      </div>
      
      <div>
        {selectedEquippedItem ? renderEquippedItemDetails() : 
         selectedInventoryItem ? renderInventoryItemDetails() : 
         renderEquipmentBonuses()}
      </div>
    </Container>
  );
}

export default EquipmentTab;