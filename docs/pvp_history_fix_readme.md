# Исправление истории PvP боёв и системы наград

## Описание проблемы

В текущей реализации PvP-системы обнаружены следующие проблемы:

1. В таблице `pvp_history` заполняются данные только о некоторых участниках (возможно, только о проигравших)
2. Поля `opponent_ids` и `team_ids` остаются пустыми
3. Поле `rewards` содержит пустой массив `{}`
4. Награды не добавляются в инвентарь игроков

## Внесенные изменения

### 1. Основные изменения в PvP-системе

Переработан метод `updateBattleHistoryAndRatings` в `src/services/pvp-service.js`:
- Добавлено заполнение полей `opponent_ids` и `team_ids` для каждого участника
- Реализована система случайного выбора наград с учетом редкости и нанесенного урона
- Добавлена интеграция с инвентарем для добавления наград игрокам
- Добавлен расчет и сохранение длительности боя

### 2. Отслеживание урона

Обновлен метод `performAction` в `src/services/pvp-service.js`:
- Добавлено накопление общего урона, нанесенного каждым участником
- Урон учитывается при нанесении обычных атак и при использовании техник
- Добавлено подробное логирование нанесенного урона

### 3. Обновление структуры базы данных

Создан SQL-скрипт `sql/43_pvp_damage_tracking.sql`:
- Добавлено поле `total_damage` в таблицу `pvp_participants`
- Создан индекс для быстрого поиска по урону
- Добавлен комментарий к полю

### 4. Инструменты для тестирования

Создан скрипт `scripts/update_pvp_history.js`:
- Запускает SQL-скрипт для обновления структуры базы данных
- Проверяет корректность записи истории боёв и расчета наград
- Выводит подробную информацию о последних записях в истории

## Система расчета наград

Реализована система случайного выбора предметов с учетом редкости и нанесенного урона:

1. **Базовые шансы для редкостей**:
   - common: 50%
   - uncommon: 25% 
   - rare: 15%
   - epic: 7%
   - legendary: 3%

2. **Бонусы к шансам**:
   - Бонус от урона: нанесенный урон / 100 (распределяется пропорционально)
   - Бонус для победителей: +10% к базовым шансам

3. **Процесс выбора наград**:
   - Сначала определяется редкость в соответствии с рассчитанными шансами
   - Затем случайно выбирается один из доступных предметов данной редкости
   - Предмет добавляется в инвентарь игрока
   - Информация о награде сохраняется в поле `rewards` в таблице `pvp_history`

## Процесс внедрения изменений

1. **Обновление кода**:
   - Обновите файл `src/services/pvp-service.js` с новой реализацией
   - Добавьте новый SQL-скрипт `sql/43_pvp_damage_tracking.sql`
   - Добавьте скрипт тестирования `scripts/update_pvp_history.js`

2. **Обновление базы данных**:
   ```
   node scripts/update_pvp_history.js
   ```

3. **Проверка работоспособности**:
   - Запустите несколько тестовых PvP-боёв
   - Проверьте, что в таблице `pvp_history` корректно заполняются все поля
   - Проверьте, что награды появляются в инвентаре игроков

## Логирование и отладка

В обновленной реализации добавлено подробное логирование каждого этапа процесса:
- Логи об общем нанесенном уроне каждым участником
- Логи о рассчитанных шансах для каждой редкости
- Логи о выбранных наградах и их добавлении в инвентарь

Для просмотра последних записей в истории боёв можно использовать скрипт:
```
node scripts/update_pvp_history.js
```

## Дополнительные улучшения

В будущем рекомендуется рассмотреть следующие улучшения:

1. Добавить UI для отображения статистики нанесенного урона в PvP-боях
2. Реализовать систему сезонов с уникальными наградами
3. Добавить систему достижений в PvP (количество побед, суммарный нанесенный урон)
4. Улучшить формулу расчета наград с учетом уровня игрока и качества противников